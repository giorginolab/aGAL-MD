# α-galactosidase MD preparation and analysis

The repo contains:

1. *glycosilation/*, contains the reglycosilated pdb structure and other glycan-related data.
2. *DGJ/*, contains DGJ chain A and B mol2 files used in mol_prep_fabry.py and other DGJ-related data.
3. *results/*, for each model and replica, contains csv tables and relative plots.
4. *functions/*, contains all the required functions to prepare the system, run it and analyse the outputs.

    - evaluation.ipynb a notebook to compute and visualise RMSD and RMSF of different contitions (relies on rmsd.py and rmsf.py);

## Tutorial
### Step 1: system building and preparation
It can be easily done by running the [mol_prep_fabry.ipynb](functions/mol_prep_fabry.ipynb) which includes:
    - mutation handling
    - glycosilation
    - DGJ (Migalastat) placement
    - system segmentation and preparation
    - equilibration folder
The notebook generates a series of folders, both for the apo and holo (DGJ) structures, divided by mutation, containing the required input parameters to run an equilibration step. 

### Step 2: equilibration run
The equilibration must be runned on HPC.
From within the `equilibration\` folder:

```bash
    conda activate htmd 
    
    sbatch sbatch_acemd
```
If multiple systems are run in parallel, it is possible to check if the equilibrations are ended by running [check_end.py](functions/check_end.py) from within the parent folder generated by the notebook:

```bash
    cd 3GXT_reglyco # change with the name of your parent folder
    
    python ../functions/check_end.py equilibration
```
*NOTE:* this file looks for the slurm file and checks if it ended correctly, more precise evaluation must be carried.

### Step 3: production preparation and run
Once the equilibration is completed it is possible to prepare the system for the production run.
From within the system folder do:

```bash
    conda activate htmd
    
    python ../../functions/production_prep.py
```
If running multiple systems in parallel, within the parent folder, do:

```bash
    conda activate htmd
    
    for dir in */; do [ -d "$dir" ] || continue; echo "Entering $dir"; (cd "$dir" && python ../../functions/production_prep.py); done
```
At this point, in both cases, it is possible to run the production. 
In some cases the production could require multiple job submission on CINECA HPC (max runtime 24 hours), to avoid doing so manually we use [sbatch_many](functions/sbatch_many). 

```bash
    conda activate htmd 
    
    sbatch sbatch_many n  #single system
    for dir in *; do [ -d "$dir/production" ] || ( echo "Skipping $dir: no production folder"; continue; ); echo "Entering $dir/production"; (cd "$dir/production" && sbatch ../../../functions/sbatch_many n); done #multiple systems in parallel
```
With *n* being the number of jobs to be generated for each system (for example, we run this system for 1 μs and used 7 jobs)

If multiple systems are run in parallel, it is possible to check if the equilibrations are ended by running [check_end.py](functions/check_end.py) from within the parent folder generated by the notebook:

```bash
    cd 3GXT_reglyco #change with the name of your parent folder
    
    python ../functions/check_end.py production
```
*NOTE:* this file looks for the slurm file with the highest number (the last run) and checks if it ended correctly, more precise evaluation must be carried.

### Step 4: 
We included a set of simple analysis based on RMSD and RMSF on protein, ligand and glycans.
All the analysis are available at [evaluation.ipynb](functions/evaluation.ipynb), while the generated data (csv files and plots) are stored in the [results/](results/) folder.


    